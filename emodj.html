<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>EmoDJ + å¿ƒç†è«®å•†å¸«æ•´åˆç‰ˆ</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #fffaf4; padding-top: 20px; }
    video { display: none; }
    canvas { width: 360px; height: 270px; border: 1px solid #ccc; }
    #song-info { margin-top: 20px; font-size: 1.1rem; }
    button {
      margin: 10px 5px;
      padding: 8px 16px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    #counsel-button {
      background-color: #f48fb1;
      display: none;
    }
    #chat-box {
      display: none;
      max-width: 480px;
      margin: 20px auto;
      background: #fef6e4;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    #chat-log {
      height: 200px;
      overflow-y: auto;
      background: #fff;
      padding: 10px;
      font-size: 14px;
      margin-bottom: 10px;
      text-align: left;
    }
    input, #chat-btn {
      padding: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h2>ğŸ§ EmoDJé»æ­Œå™¨ MOODTUBE</h2>
<p>å˜»å˜» = æ­¡æ¨‚æ­Œå–®ï¼Œä¸å˜»å˜» = æŠ’æƒ…æ­Œå–®</p>
<video id="input_video" autoplay muted playsinline></video>
<canvas id="output_canvas"></canvas>
<div id="song-info"></div>
<button id="change-song-btn">ğŸ¶ æ›ä¸€é¦–</button>
<button id="counsel-button" onclick="startCounseling()">ğŸ§  èˆ‡ AI å¿ƒç†è«®å•†å¸«èŠèŠ</button>

<div id="chat-box">
  <div id="chat-log"></div>
  <input type="text" id="chat-input" placeholder="è¼¸å…¥ä½ çš„è©±..." />
  <button id="chat-btn" onclick="sendChat()">é€å‡º</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script>
  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const info = document.getElementById('song-info');
  let currentMood = "";
  let inFlow = false, flowStage = 0;
  let usedQuotes = new Set(), usedComforts = new Set();

  const delightSongs = [{ name: "Happy â€“ Pharrell Williams", url: "https://www.youtube.com/watch?v=ZbZSe6N_BXs" },
      { name: "Canâ€™t Stop The Feeling â€“ Justin Timberlake", url: "https://www.youtube.com/watch?v=ru0K8uYEZWw" },
      { name: "Uptown Funk â€“ Bruno Mars", url: "https://www.youtube.com/watch?v=OPf0YbXqDm0" },
      { name: "Shake It Off â€“ Taylor Swift", url: "https://www.youtube.com/watch?v=nfWlot6h_JM" },
      { name: "Good Time â€“ Owl City ft. Carly Rae Jepsen", url: "https://www.youtube.com/watch?v=H7HmzwI67ec" },
      { name: "I Gotta Feeling â€“ Black Eyed Peas", url: "https://www.youtube.com/watch?v=uSD4vsh1zDA" },
      { name: "Friend of Mine â€“ Rihanna", url: "https://www.youtube.com/watch?v=yGYBuq3lhqY" },
      { name: "Be Glad (Live) â€“ Naomi Raine", url: "https://www.youtube.com/watch?v=ikV68vnANlc" },
      { name: "Party 4 U â€“ Charli XCX", url: "https://www.youtube.com/watch?v=agu22bqGHto" },
      { name: "IT Girl â€“ Jade Thirlwall", url: "https://www.youtube.com/watch?v=DO6vYic0TyA" },
      { name: "Whiplash (English Version) â€“ aespa", url: "https://www.youtube.com/watch?v=dmO8k1-lhYg" },
      { name: "Tonight â€“ PinkPantheress", url: "https://www.youtube.com/watch?v=IrEFKJnl1H8" },
      { name: "BOY CRAZY â€“ Kesha", url: "https://www.youtube.com/watch?v=sN6TMd9f7YE" },
      { name: "Tough Luck â€“ Laufey", url: "https://www.youtube.com/watch?v=9q71ywEqJjA" },
      { name: "One Thing â€“ Lola Young", url: "https://www.youtube.com/watch?v=bV9SOv_Y61s" },
      { name: "Young â€“ Little Simz", url: "https://www.youtube.com/watch?v=s07gWh37Xcc" }];
  const sadnessSongs = [ { name: "Someone Like You â€“ Adele", url: "https://www.youtube.com/watch?v=hLQl3WQQoQ0" },
      { name: "Let Her Go â€“ Passenger", url: "https://www.youtube.com/watch?v=RBumgq5yVrA" },
      { name: "All I Want â€“ Kodaline", url: "https://www.youtube.com/watch?v=8hYtUYiuzkw" },
      { name: "Fix You â€“ Coldplay", url: "https://www.youtube.com/watch?v=k4V3Mo61fJM" },
      { name: "The Night We Met â€“ Lord Huron", url: "https://www.youtube.com/watch?v=KtlgYxa6BMU" },
      { name: "Say Something â€“ A Great Big World ft. Christina Aguilera", url: "https://www.youtube.com/watch?v=-2U0Ivkn2Ds" },
      { name: "Ghostin â€“ Ariana Grande", url: "https://www.youtube.com/watch?v=d7uvl7_VaIQ" },
      { name: "Happier Than Ever â€“ Billie Eilish", url: "https://www.youtube.com/watch?v=5GJWxDKyk3A" },
      { name: "drivers license â€“ Olivia Rodrigo", url: "https://www.youtube.com/watch?v=ZmDBbnmKpqQ" },
      { name: "All Too Well (10 Minute Version) â€“ Taylor Swift", url: "https://www.youtube.com/watch?v=tollGa3S0o8" },
      { name: "Before You Go â€“ Lewis Capaldi", url: "https://www.youtube.com/watch?v=SGn6Rcx8kBQ" },
      { name: "Someone You Loved â€“ Lewis Capaldi", url: "https://www.youtube.com/watch?v=zABLecsR5UE" },
      { name: "Lovely â€“ Billie Eilish & Khalid", url: "https://www.youtube.com/watch?v=V1Pl8CzNzCw" },
      { name: "Jealous â€“ Labrinth", url: "https://www.youtube.com/watch?v=0Nw_gc0R6xo" },
      { name: "When The Party's Over â€“ Billie Eilish", url: "https://www.youtube.com/watch?v=pbMwTqkKSps" },
      { name: "Stay â€“ Rihanna ft. Mikky Ekko", url: "https://www.youtube.com/watch?v=JF8BRvqGCNs" }];

  const triggerKeywords = ["å£“åŠ›å¥½å¤§", "ç„¦æ…®", "å¤±çœ ", "ç„¡åŠ©", "æƒ³å“­", "ç…©èº", "ç…©", "ç©ºè™›", "å¥½ç´¯", "ç´¯äº†", "æ²’äººæ‡‚","é›£é","ä¸çˆ½","ç”Ÿæ°£","æ²®å–ª"];
  const comfortQuotes = [
    "ä½ å·²ç¶“å¾ˆåŠªåŠ›äº†ï¼Œè«‹ä¸è¦è²¬æ€ªè‡ªå·±ã€‚",
    "ä½ å€¼å¾—è¢«ç†è§£ï¼Œä¹Ÿå€¼å¾—è¢«æº«æŸ”ä»¥å¾…ã€‚",
    "æƒ…ç·’æ²’æœ‰å°éŒ¯ï¼Œå®ƒå€‘åªæ˜¯æƒ³å‘Šè¨´ä½ ï¼šä½ éœ€è¦è¢«ç…§é¡§ã€‚",
    "æ²’æœ‰äººç¸½æ˜¯å …å¼·ï¼Œä½ æœ‰æ¬Šåˆ©æ„Ÿåˆ°ç–²æ†Šã€‚",
    "åˆ¥æ€¥è‘—å¥½èµ·ä¾†ï¼Œæ…¢æ…¢ä¾†å°±å¥½ã€‚"
  ];
  const softComforts = [
    "æ…¢æ…¢ä¾†ï¼Œæ²’é—œä¿‚ï¼Œä½ çš„æ„Ÿå—å¾ˆé‡è¦ã€‚",
    "ä½ ä¸æ˜¯ä¸€å€‹äººï¼Œæˆ‘åœ¨é€™è£¡è½ä½ èªªã€‚",
    "èƒ½èªªå‡ºä¾†å°±æ˜¯ä¸€ç¨®å‹‡æ°£ã€‚",
    "æˆ‘æ‡‚ï¼Œé€™ä»½ç—›è‹¦ä¸æ˜¯ä½ ä¸€å€‹äººæ‰›çš„ã€‚",
    "ç¾åœ¨çš„ä½ å¾ˆæ£’ï¼Œè«‹ä¸è¦å¤ªç‚ºé›£è‡ªå·±ã€‚"
  ];

  const faceMesh = new FaceMesh({ locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
  faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

  faceMesh.onResults(results => {
    canvasElement.width = videoElement.videoWidth;
    canvasElement.height = videoElement.videoHeight;
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
    if (results.multiFaceLandmarks.length > 0) {
      const lm = results.multiFaceLandmarks[0];
      const mouthOpen = Math.abs(lm[13].y - lm[14].y);
      const isSmiling = mouthOpen > 0.04;
      const mood = isSmiling ? "Delight" : "Sadness";
      if (mood !== currentMood) {
        currentMood = mood;
        showSong(mood);
        document.getElementById("counsel-button").style.display = (mood === "Sadness") ? "inline-block" : "none";
      }
    }
  });

  const camera = new Camera(videoElement, {
    onFrame: async () => await faceMesh.send({ image: videoElement }),
    width: 360,
    height: 270
  });
  camera.start();

  document.getElementById("change-song-btn").addEventListener("click", () => {
    if (currentMood) showSong(currentMood);
  });

  function showSong(emotion) {
  const list = (emotion === "Delight" ? delightSongs : sadnessSongs);
  const song = list[Math.floor(Math.random() * list.length)];
  info.innerHTML = `ğŸµ <strong>æ¨è–¦æ­Œæ›²ï¼š</strong><br>${song.name}<br><a href="${song.url}" target="_blank">${song.url}</a>`;
}

  function startCounseling() {
    document.getElementById("chat-box").style.display = "block";
    document.getElementById("chat-log").innerHTML = `<div><strong>EmoTalkï¼š</strong>å—¨ï¼Œè¦ä¸è¦èªªèªªä½ ç¾åœ¨çš„å¿ƒæƒ…ï¼Ÿæˆ‘å¾ˆæ¨‚æ„å‚¾è½å–” ğŸ™‚</div>`;
    inFlow = false;
    flowStage = 0;
    usedQuotes.clear();
    usedComforts.clear();
  }

  function getRandomNonRepeat(list, usedSet) {
    const available = list.filter(item => !usedSet.has(item));
    if (available.length === 0) usedSet.clear();
    const newAvailable = list.filter(item => !usedSet.has(item));
    const item = newAvailable[Math.floor(Math.random() * newAvailable.length)];
    usedSet.add(item);
    return item;
  }

  function sendChat() {
    const input = document.getElementById("chat-input");
    const msg = input.value.trim();
    if (!msg) return;
    const log = document.getElementById("chat-log");
    log.innerHTML += `<div><strong>ä½ ï¼š</strong> ${msg}</div>`;
    input.value = "";
    setTimeout(() => {
      let reply = "";
      if (triggerKeywords.some(k => msg.includes(k))) {
        inFlow = true;
        flowStage = 0;
      }
      if (inFlow) {
        if (flowStage === 0) {
          reply = "é€™ä»¶äº‹æƒ…è½èµ·ä¾†å°±ä¸å¥½å—ï¼Œéœ€è¦æˆ‘çµ¦ä½ ä¸€äº›å»ºè­°å—ï¼Ÿï¼ˆè«‹è¼¸å…¥ï¼šå¥½ / ä¸ç”¨äº†ï¼‰";
          flowStage++;
        } else if (flowStage === 1) {
          if (msg.includes("å¥½")) {
            reply = `ğŸ’¬ã€Œ${getRandomNonRepeat(comfortQuotes, usedQuotes)}ã€<br><br>${getRandomNonRepeat(softComforts, usedComforts)}`;
          } else {
            reply = "æ²’é—œä¿‚ï¼Œæœ‰éœ€è¦æ­¡è¿éš¨æ™‚å›ä¾†ï¼Œå°äº†ï¼ä¸å¦¨è½é¦–æ­Œæ›²å§ ğŸµ";
          }
          inFlow = false;
        }
      } else {
        reply = "æˆ‘é‚„åœ¨é€™è£¡ï¼Œæœ‰ä»€éº¼æƒ³èªªçš„éƒ½å¯ä»¥ç¹¼çºŒå‘Šè¨´æˆ‘ã€‚";
      }
      log.innerHTML += `<div><strong>EmoTalkï¼š</strong> ${reply}</div>`;
      log.scrollTop = log.scrollHeight;
    }, 500);
  }
</script>

</body>
</html>


